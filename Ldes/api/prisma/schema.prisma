generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../data/app.db"
}

enum Role {
  TUTOR
  STUDENT
}

enum SkillCategory {
  AI
  CYBERSECURITY
  WEB_DEV
  DATA_SCIENCE
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum Status {
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  EVALUATED
  NEEDS_REVISION
  COMPLETED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role
  name         String?
  avatarUrl    String?
  createdAt    DateTime @default(now())
  lastLoginAt  DateTime?
  isActive     Boolean  @default(true)

  videos       Video[]  @relation("TutorVideos")
  submissions  Submission[]
}

model StudentTutor {
  id        String @id @default(cuid())
  student   User   @relation(fields: [studentId], references: [id])
  studentId String
  tutor     User   @relation(fields: [tutorId], references: [id])
  tutorId   String
}

model Video {
  id            String        @id @default(cuid())
  tutor         User          @relation("TutorVideos", fields: [tutorId], references: [id])
  tutorId       String
  title         String
  description   String
  skillCategory SkillCategory
  difficulty    Difficulty
  filePath      String
  thumbPath     String?
  durationSec   Int?
  sizeBytes     Int
  checksum      String
  createdAt     DateTime @default(now())

  assignments   VideoAssignment[]
}

model VideoAssignment {
  id                 String   @id @default(cuid())
  video              Video    @relation(fields: [videoId], references: [id])
  videoId            String
  assignedByTutor    User     @relation(fields: [assignedByTutorId], references: [id])
  assignedByTutorId  String
  assignedToStudent  User     @relation(fields: [assignedToStudentId], references: [id])
  assignedToStudentId String
  assignedAt         DateTime @default(now())
  dueAt              DateTime?
  status             Status   @default(ASSIGNED)
  progressPercent    Int      @default(0)
}

model Assignment {
  id            String        @id @default(cuid())
  tutor         User          @relation(fields: [tutorId], references: [id])
  tutorId       String
  title         String
  promptPath    String
  skillCategory SkillCategory
  difficulty    Difficulty
  createdAt     DateTime @default(now())
  rubricJson    String
  maxScore      Int       @default(100)

  targets       AssignmentTarget[]
}

model AssignmentTarget {
  id           String     @id @default(cuid())
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  assignmentId String
  assignedTo   User       @relation(fields: [assignedToStudentId], references: [id])
  assignedToStudentId String
  assignedAt   DateTime   @default(now())
  dueAt        DateTime?
  status       Status     @default(ASSIGNED)

  submissions  Submission[]
}

model Submission {
  id                 String        @id @default(cuid())
  assignmentTarget   AssignmentTarget @relation(fields: [assignmentTargetId], references: [id])
  assignmentTargetId String
  student            User          @relation(fields: [studentId], references: [id])
  studentId          String
  answerPath         String
  submittedAt        DateTime @default(now())
  aiEvaluation       AIEvaluation?
  isResubmission     Boolean  @default(false)
  notes              String?
}

model AIEvaluation {
  id                   String   @id @default(cuid())
  submission           Submission @relation(fields: [submissionId], references: [id])
  submissionId         String   @unique
  score                Int
  rubricBreakdownJson  String
  feedbackText         String
  modelName            String
  promptTokens         Int?
  completionTokens     Int?
  latencyMs            Int?
  createdAt            DateTime @default(now())
  isOverridden         Boolean  @default(false)
  overriddenByTutorId  String?
}

model LearningPath {
  id          String        @id @default(cuid())
  category    SkillCategory
  level       Difficulty
  title       String
  description String
  modules     LearningModule[]
}

model LearningModule {
  id                   String       @id @default(cuid())
  path                 LearningPath @relation(fields: [pathId], references: [id])
  pathId               String
  orderIndex           Int
  title                String
  contentPath          String
  estimatedMinutes     Int
  prerequisiteModuleId String?
  badgeId              String?

  progresses           ModuleProgress[]
}

model ModuleProgress {
  id         String    @id @default(cuid())
  module     LearningModule @relation(fields: [moduleId], references: [id])
  moduleId   String
  student    User      @relation(fields: [studentId], references: [id])
  studentId  String
  status     Status    @default(IN_PROGRESS)
  startedAt  DateTime  @default(now())
  completedAt DateTime?
  score      Int?

  @@unique([moduleId, studentId])
}

model Badge {
  id           String  @id @default(cuid())
  name         String
  iconPath     String
  criteriaJson String
}

model Certificate {
  id               String   @id @default(cuid())
  student          User     @relation(fields: [studentId], references: [id])
  studentId        String
  path             LearningPath @relation(fields: [pathId], references: [id])
  pathId           String
  issuedAt         DateTime @default(now())
  certificatePath  String
  verificationCode String   @unique
}

model ChatSession {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
  role          Role
  createdAt     DateTime @default(now())
  lastActivityAt DateTime @default(now())
  messages      ChatMessage[]
}

model ChatMessage {
  id           String     @id @default(cuid())
  session      ChatSession @relation(fields: [sessionId], references: [id])
  sessionId    String
  sender       String
  text         String
  attachmentsPath String?
  createdAt    DateTime   @default(now())
}

model AnalyticsEvent {
  id           String   @id @default(cuid())
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  type         String
  metadataJson String
  occurredAt   DateTime @default(now())
}


